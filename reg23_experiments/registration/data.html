<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
<meta name="generator" content="pdoc3 0.11.6">
<title>reg23_experiments.registration.data API documentation</title>
<meta name="description" content="">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/sanitize.min.css" integrity="sha512-y1dtMcuvtTMJc1yPgEqF0ZjQbhnc/bFhyvIyVNb9Zk5mIGtqVaAB1Ttl28su8AvFMOY0EwRbAe+HCLqj6W7/KA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/typography.min.css" integrity="sha512-Y1DYSb995BAfxobCkKepB1BqJJTPrOp3zPL74AWFugHHmmdcvO+C48WLrUOlhGMc0QG7AE3f7gmvvcrmX2fDoA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:1.5em;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:2em 0 .50em 0}h3{font-size:1.4em;margin:1.6em 0 .7em 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .2s ease-in-out}a:visited{color:#503}a:hover{color:#b62}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900;font-weight:bold}pre code{font-size:.8em;line-height:1.4em;padding:1em;display:block}code{background:#f3f3f3;font-family:"DejaVu Sans Mono",monospace;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source > summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible;min-width:max-content}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em 1em;margin:1em 0}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul ul{padding-left:1em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha512-D9gUyxqja7hBtkWpPWGt9wfbfaMGVt9gnyCvYa+jojwwPHLCzUm5i8rpk7vD7wNee9bA35eYIjobYPaQuKS1MQ==" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => {
hljs.configure({languages: ['bash', 'css', 'diff', 'graphql', 'ini', 'javascript', 'json', 'plaintext', 'python', 'python-repl', 'rust', 'shell', 'sql', 'typescript', 'xml', 'yaml']});
hljs.highlightAll();
/* Collapse source docstrings */
setTimeout(() => {
[...document.querySelectorAll('.hljs.language-python > .hljs-string')]
.filter(el => el.innerHTML.length > 200 && ['"""', "'''"].includes(el.innerHTML.substring(0, 3)))
.forEach(el => {
let d = document.createElement('details');
d.classList.add('hljs-string');
d.innerHTML = '<summary>"""</summary>' + el.innerHTML.substring(3);
el.replaceWith(d);
});
}, 100);
})</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>reg23_experiments.registration.data</code></h1>
</header>
<section id="section-intro">
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="reg23_experiments.registration.data.deterministic_hash_combo"><code class="name flex">
<span>def <span class="ident">deterministic_hash_combo</span></span>(<span>*hex_digests: str) ‑> str</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def deterministic_hash_combo(*hex_digests: str) -&gt; str:
    combined = b&#39;&#39;.join(bytes.fromhex(h) for h in hex_digests)
    return hashlib.sha256(combined).hexdigest()</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="reg23_experiments.registration.data.deterministic_hash_int"><code class="name flex">
<span>def <span class="ident">deterministic_hash_int</span></span>(<span>x: int) ‑> str</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def deterministic_hash_int(x: int) -&gt; str:
    return hashlib.sha256(x.to_bytes(64)).hexdigest()</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="reg23_experiments.registration.data.deterministic_hash_sinogram"><code class="name flex">
<span>def <span class="ident">deterministic_hash_sinogram</span></span>(<span>path: str,<br>sinogram_type: Type[~SinogramType],<br>sinogram_size: int,<br>downsample_factor: int) ‑> str</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def deterministic_hash_sinogram(path: str, sinogram_type: Type[SinogramType], sinogram_size: int,
                                downsample_factor: int) -&gt; str:
    return deterministic_hash_combo(deterministic_hash_string(path), deterministic_hash_type(sinogram_type),
                                    deterministic_hash_int(sinogram_size), deterministic_hash_int(downsample_factor))</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="reg23_experiments.registration.data.deterministic_hash_string"><code class="name flex">
<span>def <span class="ident">deterministic_hash_string</span></span>(<span>string: str) ‑> str</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def deterministic_hash_string(string: str) -&gt; str:
    return hashlib.sha256(string.encode()).hexdigest()</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="reg23_experiments.registration.data.deterministic_hash_type"><code class="name flex">
<span>def <span class="ident">deterministic_hash_type</span></span>(<span>tp: type) ‑> str</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def deterministic_hash_type(tp: type) -&gt; str:
    string = &#34;{}.{}&#34;.format(tp.__module__, tp.__qualname__)
    return deterministic_hash_string(string)</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="reg23_experiments.registration.data.load_cached_drr"><code class="name flex">
<span>def <span class="ident">load_cached_drr</span></span>(<span>cache_directory: str, ct_volume_path: str)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def load_cached_drr(cache_directory: str, ct_volume_path: str):
    file: str = cache_directory + &#34;/drr_spec_{}.pt&#34;.format(deterministic_hash_string(ct_volume_path))
    try:
        drr_spec = torch.load(file)
    except FileNotFoundError:
        logger.warning(&#34;No cache file &#39;{}&#39; found.&#34;.format(file))
        return None
    assert drr_spec.ct_volume_path == ct_volume_path
    detector_spacing = drr_spec.detector_spacing
    scene_geometry = drr_spec.scene_geometry
    drr_image = drr_spec.image
    transformation_ground_truth = drr_spec.transformation
    logger.info(&#34;Loaded cached drr spec from &#39;{}&#39;&#34;.format(file))
    return detector_spacing, scene_geometry, drr_image, transformation_ground_truth</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="reg23_experiments.registration.data.load_cached_volume"><code class="name flex">
<span>def <span class="ident">load_cached_volume</span></span>(<span>cache_directory: str, sinogram_hash: str) ‑> Tuple[int, <a title="reg23_experiments.registration.lib.sinogram.Sinogram" href="lib/sinogram.html#reg23_experiments.registration.lib.sinogram.Sinogram">Sinogram</a>] | None</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def load_cached_volume(cache_directory: str, sinogram_hash: str) -&gt; Tuple[int, sinogram.Sinogram] | None:
    file: str = cache_directory + &#34;/volume_spec_{}.pt&#34;.format(sinogram_hash)
    try:
        volume_spec = torch.load(file)
    except FileNotFoundError:
        logger.warning(&#34;No cache file &#39;{}&#39; found.&#34;.format(file))
        return None
    volume_downsample_factor = volume_spec.downsample_factor
    sinogram3d = volume_spec.sinogram
    logger.info(&#34;Loaded cached volume spec from &#39;{}&#39;; sinogram size = [{} x {} x {}]&#34;
                &#34;&#34;.format(file, sinogram3d.data.size()[0], sinogram3d.data.size()[1], sinogram3d.data.size()[2]))
    return volume_downsample_factor, sinogram3d</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="reg23_experiments.registration.data.load_volume"><code class="name flex">
<span>def <span class="ident">load_volume</span></span>(<span>path: pathlib.Path, *, downsample_factor: int | Literal['mipmap'] = 1) ‑> Tuple[torch.Tensor | list[torch.Tensor], torch.Tensor]</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def load_volume(path: pathlib.Path, *, downsample_factor: int | Literal[&#34;mipmap&#34;] = 1) -&gt; Tuple[
    Union[torch.Tensor, list[torch.Tensor]], torch.Tensor]:
    &#34;&#34;&#34;
    Load a CT volume from a file or directory, with desired downsampling.

    :param path: Path to a .nrrd file (a CT volume) or a directory containing multiple .dcm files (one for each slice of a CT volume)
    :type path: pathlib.Path
    :param downsample_factor: The factor by which to downsample the volume. If &#34;mipmap&#34; is given, all power-of-two downsample factors are applied, and the resulting list of images is returned.
    :type downsample_factor: int or the string literal &#34;mipmap&#34;
    :return: If downsample_factor is &#34;mipmap&#34;, the list of volumes at the mip levels, and the voxel spacing at the original resolution; otherwise the volume at the desired downsample factor, and the associated voxel spacing.
    :rtype: If downsample_factor is &#34;mipmap&#34;: Tuple[list[torch.Tensor], torch.Tensor]; otherwise Tuple[torch.Tensor, torch.Tensor]
    &#34;&#34;&#34;
    loaded_volume = read_volume(path)
    sizes = loaded_volume.data.size()
    spacing = loaded_volume.spacing
    logger.info(&#34;CT data volume size and spacing = [{} x {} x {}]; [{} x {} x {}] mm&#34;
                &#34;&#34;.format(sizes[0], sizes[1], sizes[2], spacing[0], spacing[1], spacing[2]))
    image = loaded_volume.data.to(dtype=torch.float32)
    image[image &lt; -800.0] = -800.0
    image -= image.min()
    image /= image.max()

    if downsample_factor == &#34;mipmap&#34;:
        logger.info(&#34;Downsampling volume into mipmap (all power-of-two downsample factors)...&#34;)
        down_sampler = torch.nn.AvgPool3d(2)
        images = [image]
        while min(images[-1].size()) &gt; 1:
            images.append(down_sampler(images[-1].unsqueeze(0))[0])
        logger.info(&#34;Volume downsampled to {} total mip levels.&#34;.format(len(images)))
        return images, spacing

    assert isinstance(downsample_factor, int)
    if downsample_factor &gt; 1:
        down_sampler = torch.nn.AvgPool3d(downsample_factor)
        image = down_sampler(image.unsqueeze(0))[0]
        sizes = image.size()
        spacing *= float(downsample_factor)
        logger.info(&#34;CT volume size and spacing after down-sampling = [{} x {} x {}]; [{} x {} x {}] mm&#34;
                    &#34;&#34;.format(sizes[0], sizes[1], sizes[2], spacing[0], spacing[1], spacing[2]))
    return image, spacing</code></pre>
</details>
<div class="desc"><p>Load a CT volume from a file or directory, with desired downsampling.</p>
<p>:param path: Path to a .nrrd file (a CT volume) or a directory containing multiple .dcm files (one for each slice of a CT volume)
:type path: pathlib.Path
:param downsample_factor: The factor by which to downsample the volume. If "mipmap" is given, all power-of-two downsample factors are applied, and the resulting list of images is returned.
:type downsample_factor: int or the string literal "mipmap"
:return: If downsample_factor is "mipmap", the list of volumes at the mip levels, and the voxel spacing at the original resolution; otherwise the volume at the desired downsample factor, and the associated voxel spacing.
:rtype: If downsample_factor is "mipmap": Tuple[list[torch.Tensor], torch.Tensor]; otherwise Tuple[torch.Tensor, torch.Tensor]</p></div>
</dd>
<dt id="reg23_experiments.registration.data.read_dicom"><code class="name flex">
<span>def <span class="ident">read_dicom</span></span>(<span>path: str,<br>*,<br>downsample_factor: int | None = None,<br>downsample_to_ct_spacing: float | None = None) ‑> Tuple[torch.Tensor, torch.Tensor, <a title="reg23_experiments.registration.lib.structs.SceneGeometry" href="lib/structs.html#reg23_experiments.registration.lib.structs.SceneGeometry">SceneGeometry</a>]</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def read_dicom(path: str, *, downsample_factor: int | None = None, downsample_to_ct_spacing: float | None = None) -&gt; \
        Tuple[torch.Tensor, torch.Tensor, SceneGeometry]:
    if downsample_factor is not None and downsample_to_ct_spacing is not None:
        raise RuntimeError(&#34;Cannot pass both downsample_factor and downsample_to_ct_spacing to `read_dicom()`.&#34;)
    logger.info(&#34;Loading X-ray DICOM file {}...&#34;.format(path))
    dataset = pydicom.dcmread(path)
    image = torch.tensor(pydicom.pixels.pixel_array(dataset), dtype=torch.float32)
    logger.info(&#34;X-ray image size = [{} x {}]&#34;.format(image.size()[0], image.size()[1]))

    # if &#34;PixelIntensityRelationship&#34; in dataset:
    #     logger.info(&#34;X-ray pixel intensity relationship = &#39;{}&#39;.&#34;.format(dataset[&#34;PixelIntensityRelationship&#34;]))
    # else:
    #     logger.info(&#34;No pixel intensity relationship available for X-ray.&#34;)
    #
    # if &#34;AcquisitionDeviceProcessingDescription&#34; in dataset:
    #     logger.info(&#34;X-ray AcquisitionDeviceProcessingDescription = &#39;{}&#39;.&#34;.format(dataset[&#34;AcquisitionDeviceProcessingDescription&#34;]))
    # else:
    #     logger.info(&#34;No AcquisitionDeviceProcessingDescription available for X-ray.&#34;)
    #
    # if &#34;ModalityLUTSequence&#34; in dataset:
    #     logger.info(&#34;X-ray ModalityLUTSequence = &#39;{}&#39;.&#34;.format(dataset[&#34;ModalityLUTSequence&#34;]))
    # else:
    #     logger.info(&#34;No ModalityLUTSequence available for X-ray.&#34;)
    #
    # if &#34;ModalityLUTType&#34; in dataset:
    #     logger.info(&#34;X-ray ModalityLUTType = &#39;{}&#39;.&#34;.format(dataset[&#34;ModalityLUTType&#34;]))
    # else:
    #     logger.info(&#34;No ModalityLUTType available for X-ray.&#34;)
    #
    # if &#34;VOILUTSequence&#34; in dataset:
    #     logger.info(&#34;X-ray VOILUTSequence = &#39;{}&#39;.&#34;.format(dataset[&#34;VOILUTSequence&#34;]))
    # else:
    #     logger.info(&#34;No VOILUTSequence available for X-ray.&#34;)
    #
    # if &#34;VOILUTType&#34; in dataset:
    #     logger.info(&#34;X-ray VOILUTType = &#39;{}&#39;.&#34;.format(dataset[&#34;VOILUTType&#34;]))
    # else:
    #     logger.info(&#34;No VOILUTType available for X-ray.&#34;)
    #
    # if &#34;RescaleIntercept&#34; in dataset:
    #     logger.info(&#34;X-ray RescaleIntercept = &#39;{}&#39;.&#34;.format(dataset[&#34;RescaleIntercept&#34;]))
    # else:
    #     logger.info(&#34;No RescaleIntercept available for X-ray.&#34;)

    if &#34;DistanceSourceToPatient&#34; in dataset and &#34;DistanceSourceToDetector&#34; in dataset:
        spacing_spread_ratio = float(
            dataset[&#34;DistanceSourceToDetector&#34;].value / dataset[&#34;DistanceSourceToPatient&#34;].value)
    else:
        spacing_spread_ratio = 1.0
        logger.warning(&#34;&#39;DistanceSourceToPatient&#39; and &#39;DistanceSourceToDetector&#39; not both available, assuming spacing &#34;
                       &#34;spread ratio of {} from CT volume to detector array.&#34;.format(spacing_spread_ratio))

    if &#34;PixelSpacing&#34; in dataset:
        spacing = torch.tensor([dataset[&#34;PixelSpacing&#34;][1],  # column spacing (x-direction)
                                dataset[&#34;PixelSpacing&#34;][0]  # row spacing (y-direction)
                                ])
        logger.info(&#34;X-ray pixel spacing = [{} x {}] mm&#34;.format(spacing[0], spacing[1]))
        scene_geometry = SceneGeometry(source_distance=dataset[&#34;DistanceSourceToPatient&#34;].value)
        logger.info(&#34;X-ray distance source-to-patient = {} mm&#34;.format(scene_geometry.source_distance))
    else:
        spacing = torch.tensor([dataset[&#34;ImagerPixelSpacing&#34;][1],  # column spacing (x-direction)
                                dataset[&#34;ImagerPixelSpacing&#34;][0]  # row spacing (y-direction)
                                ])
        logger.info(&#34;X-ray imager pixel spacing = [{} x {}] mm&#34;.format(spacing[0], spacing[1]))
        scene_geometry = SceneGeometry(source_distance=dataset[&#34;DistanceSourceToDetector&#34;].value)
        logger.info(&#34;X-ray distance source-to-detector = {} mm&#34;.format(scene_geometry.source_distance))

    if downsample_to_ct_spacing is not None:
        target_detector_spacing = downsample_to_ct_spacing * spacing_spread_ratio
        average_spacing = spacing.mean().item()
        downsample_factor = int(round(target_detector_spacing / average_spacing))

    if downsample_factor is not None and downsample_factor &gt; 1:
        down_sampler = torch.nn.AvgPool2d(downsample_factor)
        image = down_sampler(image.unsqueeze(0))[0]
        spacing *= float(downsample_factor)
        logger.info(&#34;X-ray image size and spacing after down-sampling = [{} x {}]; [{} x {}] mm&#34;
                    &#34;&#34;.format(image.size()[0], image.size()[1], spacing[0], spacing[1]))

    return image, spacing, scene_geometry</code></pre>
</details>
<div class="desc"></div>
</dd>
<dt id="reg23_experiments.registration.data.read_volume"><code class="name flex">
<span>def <span class="ident">read_volume</span></span>(<span>path: pathlib.Path) ‑> <a title="reg23_experiments.registration.data.LoadedVolume" href="#reg23_experiments.registration.data.LoadedVolume">LoadedVolume</a></span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def read_volume(path: pathlib.Path) -&gt; LoadedVolume:
    if path.is_file():
        logger.info(&#34;Loading CT data file &#39;{}&#39;...&#34;.format(str(path)))
        # Obtain a data tensor and a tensor of voxel spacing
        if path.suffix == &#34;.nrrd&#34;:
            data, header = nrrd.read(str(path))
            data = torch.tensor(data)
            directions = torch.tensor(header[&#39;space directions&#39;], dtype=torch.float32)
            spacing = directions.norm(dim=1).flip(dims=(0,))
            logger.warning(&#34;Don&#39;t know how to read ImageOrientationPatient from .nrrd files.&#34;)
        elif path.suffix == &#34;.nii&#34;:
            img = nibabel.load(str(path))
            data = torch.tensor(img.get_fdata())
            data = data.permute(*reversed(range(data.ndim)))
            spacing = torch.tensor(img.header.get_zooms(), dtype=torch.float32)[0:3]
            if path.stem == &#34;PhantomCT&#34;:
                data -= 1000.0  # super hacky adjustment for one particular file which appears to be HU + 1000
            logger.warning(&#34;Don&#39;t know how to read ImageOrientationPatient from .nii files.&#34;)
        else:
            raise Exception(&#34;Error: file {} is of unrecognised type.&#34;.format(str(path)))
        # Make sure there aren&#39;t unnecessary dimensions
        if len(data.size()) &gt; 3:
            data = data.squeeze()
        if len(data.size()) != 3:
            raise Exception(&#34;Error: CT volume file &#39;{}&#39; contains invalid size &#39;{}&#39;&#34;
                            &#34;&#34;.format(str(path), str(data.size())))
        return LoadedVolume(data, spacing)
    if path.is_dir():
        logger.info(&#34;Loading CT DICOM data from directory &#39;{}&#39;...&#34;.format(str(path)))
        files = [elem for elem in path.iterdir() if elem.is_file() and elem.suffix == &#34;.dcm&#34;]
        if len(files) == 0:
            raise Exception(&#34;Error: no DICOM (.dcm) files found in given directory &#39;{}&#39;.&#34;.format(str(path)))
        logger.info(&#34;Reading {} DICOM files...&#34;.format(len(files)))
        slices = [pydicom.dcmread(f) for f in tqdm(files)]
        logger.info(&#34;Done.&#34;)
        try:
            # Sort by z-position
            slices.sort(key=lambda ds: float(ds.ImagePositionPatient[2]))
        except AttributeError:
            # Fallback: sort by instance number
            slices.sort(key=lambda ds: int(ds.InstanceNumber))
            logger.warning(&#34;Sorting CT volume slices by InstanceNumber, as ImagePositionPatient not available&#34;)
        pixel_spacing = slices[0][&#34;PixelSpacing&#34;]
        slice_spacing = (torch.tensor([slices[0][&#34;ImagePositionPatient&#34;][i] for i in range(3)]) - torch.tensor(
            [slices[1][&#34;ImagePositionPatient&#34;][i] for i in range(3)])).norm()
        spacing = torch.tensor([pixel_spacing[1],  # column spacing (x-direction)
                                pixel_spacing[0],  # row spacing (y-direction)
                                slice_spacing  # slice spacing (z-direction)
                                ])
        volume = torch.stack([torch.tensor(pydicom.pixels.pixel_array(s)) for s in slices])
        logger.info(&#34;{}&#34;.format(slices[0][&#34;ImageOrientationPatient&#34;]))
        return LoadedVolume(volume, spacing)
    raise Exception(&#34;Given path &#39;{}&#39; is not a file or directory.&#34;.format(str(path)))</code></pre>
</details>
<div class="desc"></div>
</dd>
</dl>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="reg23_experiments.registration.data.LoadedVolume"><code class="flex name class">
<span>class <span class="ident">LoadedVolume</span></span>
<span>(</span><span>data: torch.Tensor, spacing: torch.Tensor)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class LoadedVolume(NamedTuple):
    data: torch.Tensor
    spacing: torch.Tensor</code></pre>
</details>
<div class="desc"><p>LoadedVolume(data, spacing)</p></div>
<h3>Ancestors</h3>
<ul class="hlist">
<li>builtins.tuple</li>
</ul>
<h3>Instance variables</h3>
<dl>
<dt id="reg23_experiments.registration.data.LoadedVolume.data"><code class="name">var <span class="ident">data</span> : torch.Tensor</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class LoadedVolume(NamedTuple):
    data: torch.Tensor
    spacing: torch.Tensor</code></pre>
</details>
<div class="desc"><p>Alias for field number 0</p></div>
</dd>
<dt id="reg23_experiments.registration.data.LoadedVolume.spacing"><code class="name">var <span class="ident">spacing</span> : torch.Tensor</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class LoadedVolume(NamedTuple):
    data: torch.Tensor
    spacing: torch.Tensor</code></pre>
</details>
<div class="desc"><p>Alias for field number 1</p></div>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="reg23_experiments.registration" href="index.html">reg23_experiments.registration</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="reg23_experiments.registration.data.deterministic_hash_combo" href="#reg23_experiments.registration.data.deterministic_hash_combo">deterministic_hash_combo</a></code></li>
<li><code><a title="reg23_experiments.registration.data.deterministic_hash_int" href="#reg23_experiments.registration.data.deterministic_hash_int">deterministic_hash_int</a></code></li>
<li><code><a title="reg23_experiments.registration.data.deterministic_hash_sinogram" href="#reg23_experiments.registration.data.deterministic_hash_sinogram">deterministic_hash_sinogram</a></code></li>
<li><code><a title="reg23_experiments.registration.data.deterministic_hash_string" href="#reg23_experiments.registration.data.deterministic_hash_string">deterministic_hash_string</a></code></li>
<li><code><a title="reg23_experiments.registration.data.deterministic_hash_type" href="#reg23_experiments.registration.data.deterministic_hash_type">deterministic_hash_type</a></code></li>
<li><code><a title="reg23_experiments.registration.data.load_cached_drr" href="#reg23_experiments.registration.data.load_cached_drr">load_cached_drr</a></code></li>
<li><code><a title="reg23_experiments.registration.data.load_cached_volume" href="#reg23_experiments.registration.data.load_cached_volume">load_cached_volume</a></code></li>
<li><code><a title="reg23_experiments.registration.data.load_volume" href="#reg23_experiments.registration.data.load_volume">load_volume</a></code></li>
<li><code><a title="reg23_experiments.registration.data.read_dicom" href="#reg23_experiments.registration.data.read_dicom">read_dicom</a></code></li>
<li><code><a title="reg23_experiments.registration.data.read_volume" href="#reg23_experiments.registration.data.read_volume">read_volume</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="reg23_experiments.registration.data.LoadedVolume" href="#reg23_experiments.registration.data.LoadedVolume">LoadedVolume</a></code></h4>
<ul class="">
<li><code><a title="reg23_experiments.registration.data.LoadedVolume.data" href="#reg23_experiments.registration.data.LoadedVolume.data">data</a></code></li>
<li><code><a title="reg23_experiments.registration.data.LoadedVolume.spacing" href="#reg23_experiments.registration.data.LoadedVolume.spacing">spacing</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.11.6</a>.</p>
</footer>
</body>
</html>
